<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Planner de Estudos</title>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --accent: #ff6b6b;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow);
            border-radius: 0 0 var(--radius) var(--radius);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .premium-badge {
            background-color: var(--warning);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Timer Styles */
        .timer-container {
            text-align: center;
            padding: 20px;
        }

        .timer-display {
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary);
            margin: 20px 0;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .timer-modes {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .mode-btn {
            padding: 8px 15px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .timer-settings {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .setting {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .setting label {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .setting input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            text-align: center;
        }

        /* Task List Styles */
        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .task-item:hover {
            background-color: #f8f9fa;
        }

        .task-item.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        .task-checkbox {
            margin-right: 10px;
        }

        .task-name {
            flex-grow: 1;
        }

        .task-actions {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary);
            font-size: 1.1rem;
        }

        .add-task {
            display: flex;
            margin-top: 15px;
        }

        .add-task input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius) 0 0 var(--radius);
        }

        .add-task button {
            border-radius: 0 var(--radius) var(--radius) 0;
        }

        /* Stats Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Premium Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .premium-features {
            list-style: none;
            margin: 20px 0;
        }

        .premium-features li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .premium-features li:before {
            content: "‚úì";
            color: var(--success);
            font-weight: bold;
            margin-right: 10px;
        }

        .premium-price {
            text-align: center;
            font-size: 1.5rem;
            margin: 20px 0;
            color: var(--primary);
        }

        .upgrade-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--warning), #ff9500);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* Ad Container */
        .ad-container {
            background: #f0f0f0;
            border: 1px dashed #ccc;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            color: #666;
        }

        /* Flashcard Styles */
        .flashcard {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .flashcard:hover {
            transform: translateY(-5px);
        }

        .flashcard-front, .flashcard-back {
            text-align: center;
            padding: 20px;
        }

        .flashcard-back {
            display: none;
        }

        .flashcard.flipped .flashcard-front {
            display: none;
        }

        .flashcard.flipped .flashcard-back {
            display: block;
        }

        .flashcard-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .theme-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .theme {
            padding: 8px 15px;
            background: #eee;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme.active {
            background: var(--primary);
            color: white;
        }

        .theme.locked {
            background: #ddd;
            color: #999;
            position: relative;
        }

        .theme.locked:after {
            content: "üîí";
            margin-left: 5px;
        }

        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .info-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .info-section ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .info-section li {
            margin-bottom: 8px;
        }

        .data-management {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .json-viewer {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>StudyFlow - Seu Planner de Estudos</h1>
                <div class="premium-badge" id="premiumBadge">Free</div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="app-container">
            <!-- Coluna 1: Timer e Tarefas -->
            <div>
                <!-- Timer Pomodoro -->
                <div class="card">
                    <h2 class="card-title">Temporizador Pomodoro</h2>
                    <div class="timer-container">
                        <div class="timer-modes">
                            <button class="mode-btn active" data-mode="work">Trabalho</button>
                            <button class="mode-btn" data-mode="break">Pausa Curta</button>
                            <button class="mode-btn" data-mode="longBreak">Pausa Longa</button>
                        </div>
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="timer-controls">
                            <button class="btn btn-primary" id="startBtn">Iniciar</button>
                            <button class="btn btn-secondary" id="pauseBtn" disabled>Pausar</button>
                            <button class="btn btn-danger" id="resetBtn">Resetar</button>
                        </div>
                        <div class="timer-settings">
                            <div class="setting">
                                <label for="workDuration">Trabalho (min)</label>
                                <input type="number" id="workDuration" min="1" max="60" value="25">
                            </div>
                            <div class="setting">
                                <label for="breakDuration">Pausa (min)</label>
                                <input type="number" id="breakDuration" min="1" max="30" value="5">
                            </div>
                            <div class="setting">
                                <label for="longBreakDuration">Pausa Longa (min)</label>
                                <input type="number" id="longBreakDuration" min="1" max="60" value="15">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Tarefas -->
                <div class="card">
                    <h2 class="card-title">Tarefas de Estudo</h2>
                    <ul class="task-list" id="taskList">
                        <!-- Tarefas ser√£o adicionadas dinamicamente -->
                    </ul>
                    <div class="add-task">
                        <input type="text" id="newTaskInput" placeholder="Adicionar nova tarefa...">
                        <button class="btn btn-primary" id="addTaskBtn">+</button>
                    </div>
                </div>

                <!-- An√∫ncio (ser√° mostrado entre sess√µes) -->
                <div class="ad-container" id="adContainer">
                    <h3>An√∫ncio</h3>
                    <p>Upgrade para Premium para remover an√∫ncios!</p>
                    <button class="btn btn-warning" id="learnMoreBtn">Saiba Mais</button>
                </div>
            </div>

            <!-- Coluna 2: Estat√≠sticas e Flashcards -->
            <div>
                <!-- Estat√≠sticas -->
                <div class="card">
                    <h2 class="card-title">Estat√≠sticas</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="sessionsCompleted">0</div>
                            <div class="stat-label">Sess√µes Completas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalStudyTime">0h</div>
                            <div class="stat-label">Tempo Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="tasksCompleted">0</div>
                            <div class="stat-label">Tarefas Conclu√≠das</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="productivityScore">0%</div>
                            <div class="stat-label">Produtividade</div>
                        </div>
                    </div>
                </div>

                <!-- Sele√ß√£o de Temas -->
                <div class="card">
                    <h2 class="card-title">Temas de Estudo</h2>
                    <div class="theme-selector" id="themeSelector">
                        <!-- Temas ser√£o adicionados dinamicamente -->
                    </div>
                </div>

                <!-- Flashcards -->
                <div class="card">
                    <h2 class="card-title">Flashcards</h2>
                    <div class="flashcard" id="flashcard">
                        <div class="flashcard-front">
                            <p>Clique para ver a resposta</p>
                        </div>
                        <div class="flashcard-back">
                            <p>Resposta do flashcard</p>
                        </div>
                    </div>
                    <div class="flashcard-actions">
                        <button class="btn btn-secondary" id="prevCardBtn" disabled>Anterior</button>
                        <button class="btn btn-primary" id="nextCardBtn">Pr√≥ximo</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-success" id="createCardBtn">Criar Flashcard</button>
                    </div>
                </div>

                <!-- Gerenciamento de Dados -->
                <div class="card">
                    <h2 class="card-title">Gerenciamento de Dados</h2>
                    <p>Seus dados s√£o salvos automaticamente em formato JSON</p>
                    <div class="data-management">
                        <button class="btn btn-info" id="exportDataBtn">Exportar JSON</button>
                        <button class="btn btn-warning" id="importDataBtn">Importar JSON</button>
                        <button class="btn btn-danger" id="clearDataBtn">Limpar Dados</button>
                    </div>
                    <div class="json-viewer" id="jsonViewer">
                        {/* JSON ser√° exibido aqui */}
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Informa√ß√µes -->
        <div class="info-section">
            <h3>Como funciona o StudyFlow?</h3>
            <p>O StudyFlow √© um planner de estudos que utiliza a t√©cnica Pomodoro para melhorar sua produtividade:</p>
            <ul>
                <li><strong>Temporizador Pomodoro</strong>: Estude por 25 minutos e fa√ßa pausas de 5 minutos. A cada 4 sess√µes, fa√ßa uma pausa longa de 15-30 minutos.</li>
                <li><strong>Lista de Tarefas</strong>: Organize seus t√≥picos de estudo e marque como conclu√≠dos.</li>
                <li><strong>Flashcards</strong>: Crie cart√µes de revis√£o para memoriza√ß√£o.</li>
                <li><strong>Estat√≠sticas</strong>: Acompanhe seu progresso e produtividade.</li>
                <li><strong>Temas</strong>: Organize seus estudos por mat√©rias ou t√≥picos.</li>
            </ul>
            
            <h3>Sistema de Salvamento em JSON</h3>
            <p>Seus dados s√£o salvos automaticamente em formato JSON sempre que voc√™:</p>
            <ul>
                <li>Adiciona, conclui ou remove uma tarefa</li>
                <li>Completa uma sess√£o Pomodoro</li>
                <li>Cria ou navega entre flashcards</li>
                <li>Altera configura√ß√µes do timer</li>
                <li>Ativa o modo premium</li>
            </ul>
            <p>O JSON √© salvo no localStorage do navegador e pode ser exportado/importado a qualquer momento.</p>
        </div>
    </div>

    <!-- Modal Premium -->
    <div class="modal" id="premiumModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upgrade para Premium</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <p>Desbloqueie todos os recursos premium por apenas:</p>
            <div class="premium-price">R$ 9,90/m√™s</div>
            <ul class="premium-features">
                <li>Todos os temas de estudo desbloqueados</li>
                <li>Estat√≠sticas avan√ßadas</li>
                <li>Flashcards ilimitados</li>
                <li>Sem an√∫ncios</li>
                <li>Exporta√ß√£o de dados</li>
            </ul>
            <div class="ad-container" style="margin: 20px 0;">
                <p>√Årea para inser√ß√£o de chave premium</p>
                <input type="text" id="premiumKeyInput" placeholder="Digite sua chave premium" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: var(--radius);">
                <button class="btn btn-success" id="activatePremiumBtn" style="width: 100%;">Ativar Premium</button>
            </div>
            <button class="upgrade-btn" id="upgradeBtn">Fazer Upgrade Agora</button>
        </div>
    </div>

    <!-- Input oculto para importa√ß√£o de arquivo -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <script>
        // Elementos do DOM
        const timerDisplay = document.getElementById('timerDisplay');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const workDurationInput = document.getElementById('workDuration');
        const breakDurationInput = document.getElementById('breakDuration');
        const longBreakDurationInput = document.getElementById('longBreakDuration');
        const taskList = document.getElementById('taskList');
        const newTaskInput = document.getElementById('newTaskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const sessionsCompletedEl = document.getElementById('sessionsCompleted');
        const totalStudyTimeEl = document.getElementById('totalStudyTime');
        const tasksCompletedEl = document.getElementById('tasksCompleted');
        const productivityScoreEl = document.getElementById('productivityScore');
        const themeSelector = document.getElementById('themeSelector');
        const flashcard = document.getElementById('flashcard');
        const prevCardBtn = document.getElementById('prevCardBtn');
        const nextCardBtn = document.getElementById('nextCardBtn');
        const createCardBtn = document.getElementById('createCardBtn');
        const premiumBadge = document.getElementById('premiumBadge');
        const premiumModal = document.getElementById('premiumModal');
        const closeModal = document.getElementById('closeModal');
        const learnMoreBtn = document.getElementById('learnMoreBtn');
        const adContainer = document.getElementById('adContainer');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const premiumKeyInput = document.getElementById('premiumKeyInput');
        const activatePremiumBtn = document.getElementById('activatePremiumBtn');
        const upgradeBtn = document.getElementById('upgradeBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const jsonViewer = document.getElementById('jsonViewer');
        const fileInput = document.getElementById('fileInput');

        // Estado da aplica√ß√£o
        let state = {
            timer: {
                isRunning: false,
                currentMode: 'work', // 'work', 'break', 'longBreak'
                timeLeft: 25 * 60, // 25 minutos em segundos
                workDuration: 25,
                breakDuration: 5,
                longBreakDuration: 15,
                sessionsCompleted: 0,
                totalStudyTime: 0,
                sessionsBeforeLongBreak: 0,
                lastUpdated: new Date().toISOString()
            },
            tasks: [],
            currentTheme: 'geral',
            themes: [
                { id: 'geral', name: 'Geral', locked: false },
                { id: 'matematica', name: 'Matem√°tica', locked: false },
                { id: 'portugues', name: 'Portugu√™s', locked: true },
                { id: 'historia', name: 'Hist√≥ria', locked: true },
                { id: 'ciencias', name: 'Ci√™ncias', locked: true },
                { id: 'ingles', name: 'Ingl√™s', locked: true }
            ],
            flashcards: [
                { id: 1, front: 'O que √© a t√©cnica Pomodoro?', back: '√â um m√©todo de gerenciamento de tempo que usa temporizador para dividir o trabalho em intervalos.' },
                { id: 2, front: 'Qual a dura√ß√£o padr√£o de um Pomodoro?', back: '25 minutos de trabalho seguidos de 5 minutos de pausa.' }
            ],
            currentFlashcardIndex: 0,
            isPremium: false,
            appVersion: '1.0.0',
            lastSave: new Date().toISOString()
        };

        // Inicializa√ß√£o
        function init() {
            loadState();
            renderTasks();
            renderThemes();
            renderFlashcard();
            updateStats();
            setupEventListeners();
            updateTimerDisplay();
            updateModeButtons();
            updateJSONViewer();
        }

        // Carregar estado do localStorage
        function loadState() {
            const savedState = localStorage.getItem('studyFlowJSON');
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    
                    // Preservar dados importantes se a vers√£o for diferente
                    if (parsedState.appVersion !== state.appVersion) {
                        console.log('Vers√£o diferente detectada, mesclando dados...');
                        // Mesclar dados importantes
                        if (parsedState.timer) state.timer = {...state.timer, ...parsedState.timer};
                        if (parsedState.tasks) state.tasks = parsedState.tasks;
                        if (parsedState.flashcards) state.flashcards = parsedState.flashcards;
                        if (parsedState.isPremium !== undefined) state.isPremium = parsedState.isPremium;
                    } else {
                        state = {...state, ...parsedState};
                    }
                    
                    // Atualizar inputs com valores salvos
                    workDurationInput.value = state.timer.workDuration;
                    breakDurationInput.value = state.timer.breakDuration;
                    longBreakDurationInput.value = state.timer.longBreakDuration;
                    
                    // Configurar timer com valores salvos
                    updateTimerForCurrentMode();
                    updateTimerDisplay();
                    
                    // Atualizar badge premium
                    updatePremiumBadge();
                    
                    console.log('Dados carregados do JSON:', state);
                } catch (error) {
                    console.error('Erro ao carregar dados do JSON:', error);
                }
            }
        }

        // Salvar estado no localStorage em formato JSON
        function saveState() {
            try {
                // Atualizar timestamp
                state.lastSave = new Date().toISOString();
                
                // Converter para JSON
                const jsonData = JSON.stringify(state, null, 2);
                
                // Salvar no localStorage
                localStorage.setItem('studyFlowJSON', jsonData);
                
                // Atualizar visualizador JSON
                updateJSONViewer();
                
                console.log('Dados salvos em JSON:', state);
            } catch (error) {
                console.error('Erro ao salvar dados em JSON:', error);
            }
        }

        // Atualizar visualizador JSON
        function updateJSONViewer() {
            jsonViewer.textContent = JSON.stringify(state, null, 2);
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Timer
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            workDurationInput.addEventListener('change', updateTimerSettings);
            breakDurationInput.addEventListener('change', updateTimerSettings);
            longBreakDurationInput.addEventListener('change', updateTimerSettings);
            
            // Modos do timer
            modeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    switchMode(mode);
                });
            });
            
            // Tarefas
            addTaskBtn.addEventListener('click', addTask);
            newTaskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            
            // Flashcards
            flashcard.addEventListener('click', flipFlashcard);
            prevCardBtn.addEventListener('click', showPrevFlashcard);
            nextCardBtn.addEventListener('click', showNextFlashcard);
            createCardBtn.addEventListener('click', createFlashcard);
            
            // Premium
            premiumBadge.addEventListener('click', showPremiumModal);
            closeModal.addEventListener('click', hidePremiumModal);
            learnMoreBtn.addEventListener('click', showPremiumModal);
            activatePremiumBtn.addEventListener('click', activatePremium);
            upgradeBtn.addEventListener('click', showPremiumModal);
            
            // Gerenciamento de dados
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', importData);
            clearDataBtn.addEventListener('click', clearData);
            fileInput.addEventListener('change', handleFileUpload);
            
            // Fechar modal ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === premiumModal) {
                    hidePremiumModal();
                }
            });

            // Salvar automaticamente quando a p√°gina for fechada
            window.addEventListener('beforeunload', saveState);
        }

        // Fun√ß√µes do Timer
        function startTimer() {
            if (!state.timer.isRunning) {
                state.timer.isRunning = true;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                
                state.timer.intervalId = setInterval(() => {
                    state.timer.timeLeft--;
                    updateTimerDisplay();
                    
                    if (state.timer.timeLeft <= 0) {
                        clearInterval(state.timer.intervalId);
                        timerComplete();
                    }
                    
                    // Salvar a cada 10 segundos enquanto o timer est√° rodando
                    if (state.timer.timeLeft % 10 === 0) {
                        saveState();
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (state.timer.isRunning) {
                state.timer.isRunning = false;
                clearInterval(state.timer.intervalId);
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                saveState(); // Salvar ao pausar
            }
        }

        function resetTimer() {
            pauseTimer();
            updateTimerForCurrentMode();
            updateTimerDisplay();
            saveState(); // Salvar ao resetar
        }

        function switchMode(mode) {
            // N√£o permitir trocar de modo com timer rodando
            if (state.timer.isRunning) {
                alert('Pare o timer antes de trocar de modo');
                return;
            }
            
            state.timer.currentMode = mode;
            updateTimerForCurrentMode();
            updateTimerDisplay();
            updateModeButtons();
            saveState(); // Salvar ao trocar de modo
        }

        function updateModeButtons() {
            modeButtons.forEach(btn => {
                if (btn.dataset.mode === state.timer.currentMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function updateTimerForCurrentMode() {
            switch(state.timer.currentMode) {
                case 'work':
                    state.timer.timeLeft = state.timer.workDuration * 60;
                    break;
                case 'break':
                    state.timer.timeLeft = state.timer.breakDuration * 60;
                    break;
                case 'longBreak':
                    state.timer.timeLeft = state.timer.longBreakDuration * 60;
                    break;
            }
        }

        function updateTimerSettings() {
            state.timer.workDuration = parseInt(workDurationInput.value) || 25;
            state.timer.breakDuration = parseInt(breakDurationInput.value) || 5;
            state.timer.longBreakDuration = parseInt(longBreakDurationInput.value) || 15;
            
            if (!state.timer.isRunning) {
                updateTimerForCurrentMode();
                updateTimerDisplay();
            }
            
            saveState(); // Salvar ao alterar configura√ß√µes
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timer.timeLeft / 60);
            const seconds = state.timer.timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Mudar cor do timer baseado no modo
            if (state.timer.currentMode === 'work') {
                timerDisplay.style.color = 'var(--primary)';
            } else {
                timerDisplay.style.color = 'var(--success)';
            }
        }

        function timerComplete() {
            state.timer.isRunning = false;
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            
            // Tocar som de notifica√ß√£o
            playNotificationSound();
            
            if (state.timer.currentMode === 'work') {
                // Sess√£o de trabalho conclu√≠da
                state.timer.sessionsCompleted++;
                state.timer.totalStudyTime += state.timer.workDuration;
                state.timer.sessionsBeforeLongBreak++;
                
                // Mostrar an√∫ncio se n√£o for premium
                if (!state.isPremium) {
                    adContainer.style.display = 'block';
                }
                
                // Verificar se √© hora de uma pausa longa
                if (state.timer.sessionsBeforeLongBreak >= 4) {
                    state.timer.currentMode = 'longBreak';
                    state.timer.sessionsBeforeLongBreak = 0;
                    alert('Sess√£o de trabalho conclu√≠da! Hora de uma pausa longa.');
                } else {
                    state.timer.currentMode = 'break';
                    alert('Sess√£o de trabalho conclu√≠da! Hora de uma pausa curta.');
                }
            } else {
                // Pausa conclu√≠da, voltar ao trabalho
                state.timer.currentMode = 'work';
                alert('Pausa conclu√≠da! Volte ao trabalho.');
                
                // Esconder an√∫ncio
                adContainer.style.display = 'none';
            }
            
            updateTimerForCurrentMode();
            updateTimerDisplay();
            updateModeButtons();
            updateStats();
            saveState(); // Salvar ao completar sess√£o
        }

        function playNotificationSound() {
            // Criar um som de notifica√ß√£o simples
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Tarefas
        function addTask() {
            const taskText = newTaskInput.value.trim();
            if (taskText) {
                const newTask = {
                    id: Date.now(),
                    text: taskText,
                    completed: false,
                    theme: state.currentTheme,
                    createdAt: new Date().toISOString(),
                    completedAt: null
                };
                
                state.tasks.push(newTask);
                newTaskInput.value = '';
                renderTasks();
                updateStats();
                saveState(); // Salvar ao adicionar tarefa
            }
        }

        function toggleTask(id) {
            const task = state.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                task.completedAt = task.completed ? new Date().toISOString() : null;
                renderTasks();
                updateStats();
                saveState(); // Salvar ao alternar tarefa
            }
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            renderTasks();
            updateStats();
            saveState(); // Salvar ao deletar tarefa
        }

        function renderTasks() {
            taskList.innerHTML = '';
            
            const filteredTasks = state.tasks.filter(task => 
                state.currentTheme === 'geral' || task.theme === state.currentTheme
            );
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = '<li style="text-align: center; padding: 20px; color: #666;">Nenhuma tarefa adicionada</li>';
                return;
            }
            
            filteredTasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                    <span class="task-name">${task.text}</span>
                    <div class="task-actions">
                        <button class="icon-btn delete-task">üóëÔ∏è</button>
                    </div>
                `;
                
                const checkbox = taskItem.querySelector('.task-checkbox');
                const deleteBtn = taskItem.querySelector('.delete-task');
                
                checkbox.addEventListener('change', () => toggleTask(task.id));
                deleteBtn.addEventListener('click', () => deleteTask(task.id));
                
                taskList.appendChild(taskItem);
            });
        }

        // Temas
        function renderThemes() {
            themeSelector.innerHTML = '';
            
            state.themes.forEach(theme => {
                const themeEl = document.createElement('div');
                themeEl.className = `theme ${theme.locked ? 'locked' : ''} ${state.currentTheme === theme.id ? 'active' : ''}`;
                themeEl.textContent = theme.name;
                
                if (!theme.locked || state.isPremium) {
                    themeEl.addEventListener('click', () => {
                        state.currentTheme = theme.id;
                        renderThemes();
                        renderTasks();
                        saveState(); // Salvar ao trocar tema
                    });
                } else {
                    themeEl.addEventListener('click', () => {
                        if (!state.isPremium) {
                            showPremiumModal();
                        }
                    });
                }
                
                themeSelector.appendChild(themeEl);
            });
        }

        // Flashcards
        function renderFlashcard() {
            if (state.flashcards.length === 0) {
                flashcard.innerHTML = '<p>Nenhum flashcard dispon√≠vel. Crie o primeiro!</p>';
                prevCardBtn.disabled = true;
                nextCardBtn.disabled = true;
                return;
            }
            
            const currentCard = state.flashcards[state.currentFlashcardIndex];
            flashcard.querySelector('.flashcard-front p').textContent = currentCard.front;
            flashcard.querySelector('.flashcard-back p').textContent = currentCard.back;
            flashcard.classList.remove('flipped');
            
            prevCardBtn.disabled = state.currentFlashcardIndex === 0;
            nextCardBtn.disabled = state.currentFlashcardIndex === state.flashcards.length - 1;
        }

        function flipFlashcard() {
            flashcard.classList.toggle('flipped');
        }

        function showPrevFlashcard() {
            if (state.currentFlashcardIndex > 0) {
                state.currentFlashcardIndex--;
                renderFlashcard();
                saveState(); // Salvar ao navegar entre flashcards
            }
        }

        function showNextFlashcard() {
            if (state.currentFlashcardIndex < state.flashcards.length - 1) {
                state.currentFlashcardIndex++;
                renderFlashcard();
                saveState(); // Salvar ao navegar entre flashcards
            }
        }

        function createFlashcard() {
            if (!state.isPremium && state.flashcards.length >= 2) {
                showPremiumModal();
                return;
            }
            
            const front = prompt('Digite a pergunta do flashcard:');
            if (front) {
                const back = prompt('Digite a resposta do flashcard:');
                if (back) {
                    const newCard = {
                        id: Date.now(),
                        front: front,
                        back: back,
                        theme: state.currentTheme,
                        createdAt: new Date().toISOString()
                    };
                    
                    state.flashcards.push(newCard);
                    state.currentFlashcardIndex = state.flashcards.length - 1;
                    renderFlashcard();
                    saveState(); // Salvar ao criar flashcard
                }
            }
        }

        // Estat√≠sticas
        function updateStats() {
            sessionsCompletedEl.textContent = state.timer.sessionsCompleted;
            
            const totalHours = Math.floor(state.timer.totalStudyTime / 60);
            const totalMinutes = state.timer.totalStudyTime % 60;
            totalStudyTimeEl.textContent = `${totalHours}h ${totalMinutes}m`;
            
            const completedTasks = state.tasks.filter(t => t.completed).length;
            tasksCompletedEl.textContent = completedTasks;
            
            const totalTasks = state.tasks.length;
            const productivity = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            productivityScoreEl.textContent = `${productivity}%`;
        }

        // Premium
        function showPremiumModal() {
            premiumModal.style.display = 'flex';
        }

        function hidePremiumModal() {
            premiumModal.style.display = 'none';
        }

        function activatePremium() {
            const key = premiumKeyInput.value.trim();
            // Simula√ß√£o de valida√ß√£o de chave
            if (key === 'PREMIUM2024' || key === 'TESTE123') {
                state.isPremium = true;
                updatePremiumBadge();
                hidePremiumModal();
                renderThemes();
                alert('Premium ativado com sucesso!');
                saveState(); // Salvar ao ativar premium
            } else {
                alert('Chave premium inv√°lida. Use PREMIUM2024 ou TESTE123 para teste.');
            }
        }

        function updatePremiumBadge() {
            if (state.isPremium) {
                premiumBadge.textContent = 'Premium';
                premiumBadge.style.backgroundColor = 'var(--success)';
                premiumBadge.style.color = 'white';
            } else {
                premiumBadge.textContent = 'Free';
                premiumBadge.style.backgroundColor = 'var(--warning)';
                premiumBadge.style.color = 'var(--dark)';
            }
        }

        // Gerenciamento de dados
        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `studyflow-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importData() {
            fileInput.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    
                    if (confirm('Isso substituir√° todos os seus dados atuais. Continuar?')) {
                        state = {...state, ...importedState};
                        
                        // Atualizar a interface
                        loadState();
                        renderTasks();
                        renderThemes();
                        renderFlashcard();
                        updateStats();
                        updateTimerDisplay();
                        updateModeButtons();
                        updatePremiumBadge();
                        
                        alert('Dados importados com sucesso!');
                        saveState(); // Salvar ap√≥s importa√ß√£o
                    }
                } catch (error) {
                    alert('Erro ao importar arquivo. Verifique se √© um JSON v√°lido.');
                    console.error('Erro na importa√ß√£o:', error);
                }
            };
            reader.readAsText(file);
            
            // Limpar o input para permitir importar o mesmo arquivo novamente
            event.target.value = '';
        }

        function clearData() {
            if (confirm('Isso apagar√° TODOS os seus dados permanentemente. Continuar?')) {
                localStorage.removeItem('studyFlowJSON');
                state = {
                    timer: {
                        isRunning: false,
                        currentMode: 'work',
                        timeLeft: 25 * 60,
                        workDuration: 25,
                        breakDuration: 5,
                        longBreakDuration: 15,
                        sessionsCompleted: 0,
                        totalStudyTime: 0,
                        sessionsBeforeLongBreak: 0,
                        lastUpdated: new Date().toISOString()
                    },
                    tasks: [],
                    currentTheme: 'geral',
                    themes: [
                        { id: 'geral', name: 'Geral', locked: false },
                        { id: 'matematica', name: 'Matem√°tica', locked: false },
                        { id: 'portugues', name: 'Portugu√™s', locked: true },
                        { id: 'historia', name: 'Hist√≥ria', locked: true },
                        { id: 'ciencias', name: 'Ci√™ncias', locked: true },
                        { id: 'ingles', name: 'Ingl√™s', locked: true }
                    ],
                    flashcards: [
                        { id: 1, front: 'O que √© a t√©cnica Pomodoro?', back: '√â um m√©todo de gerenciamento de tempo que usa temporizador para dividir o trabalho em intervalos.' },
                        { id: 2, front: 'Qual a dura√ß√£o padr√£o de um Pomodoro?', back: '25 minutos de trabalho seguidos de 5 minutos de pausa.' }
                    ],
                    currentFlashcardIndex: 0,
                    isPremium: false,
                    appVersion: '1.0.0',
                    lastSave: new Date().toISOString()
                };
                
                // Atualizar a interface
                renderTasks();
                renderThemes();
                renderFlashcard();
                updateStats();
                updateTimerDisplay();
                updateModeButtons();
                updatePremiumBadge();
                updateJSONViewer();
                
                alert('Todos os dados foram apagados.');
            }
        }

        // Inicializar a aplica√ß√£o
        init();
    </script>
</body>
</html>
